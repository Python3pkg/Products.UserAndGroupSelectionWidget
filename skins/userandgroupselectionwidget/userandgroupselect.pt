<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="userandgroupselectionwidget">
   <head><title></title></head>
   <body>

     <metal:view_macro define-macro="view" 
                       tal:define="value accessor;
                                   multiVal field/multiValued;">

       <tal:single tal:condition="not:multiVal">

          <tal:block tal:define="minfo python:mtool.getMemberInfo(value);
                                   home python:mtool.getHomeFolder(value);">
               <a href="" tal:attributes="href home/absolute_url | nothing">
                 <tal:fullname tal:condition="widget/show_fullname"
                   ><tal:block tal:define="fullname minfo/fullname"
                               tal:content="fullname | value"
                    /></tal:fullname>
                 <tal:notfullname tal:condition="not:widget/show_fullname">
                      <span tal:content="value"/>
                 </tal:notfullname>
               </a>  
          </tal:block>

       </tal:single>

       <tal:multival tal:condition="multiVal">

           <tal:users tal:repeat="username value">  
             <tal:user tal:define="minfo python:mtool.getMemberInfo(username);
                                   home python:mtool.getHomeFolder(username);">
               <a href="" tal:attributes="href home/absolute_url | nothing" tal:omit-tag="not:widget/link_to_home">
                 <tal:fullname tal:condition="widget/show_fullname"
                   ><tal:block tal:define="fullname minfo/fullname"
                               tal:content="fullname | username"
                    /></tal:fullname>
                 <tal:notfullname tal:condition="not:widget/show_fullname">
                      <span tal:content="username"/>
                 </tal:notfullname>
               </a><br />
             </tal:user>
           </tal:users> 
 
       </tal:multival>

     </metal:view_macro>

     <metal:edit_macro define-macro="edit">
       <metal:use use-macro="field_macro | here/widgets/field/macros/edit">

          <div metal:fill-slot="widget_body"
               tal:define="multiVal python:test(field.multiValued, 1, 0); 
                           field_required field/required;
                           fieldId fieldId | fieldName;
                           size widget/size | nothing;
                           groupId python: widget.getGroupId(context);">

            <input type="hidden" value=""
                   tal:define="field_required field_required | nothing"
                   tal:condition="python:not field_required and multiVal"
                   tal:attributes="name string:$fieldName:default:list"
                   />

            <tal:single condition="not: multiVal">
               <input tal:condition="value"
                      size="30"
                      type="text"
                      value=""
                      tal:define="member python:mtool.getMemberInfo(value);
                                  fullname python:member and member['fullname'] or value;"
                      tal:attributes="value string:$value ($fullname);
                                      id string:${fieldId}_label"
                      readonly="readonly"
                      />
               <input tal:condition="not: value"
                      size="30"
                      type="text"
                      value=""
                      tal:attributes="id string:${fieldId}_label"
                      readonly="readonly"
                      />
               <input type="hidden"
                      value=""
                      name=""
                      tal:attributes="name fieldName;
                                      value value;
                                      id fieldId"/>
            </tal:single>

            <tal:multi tal:condition="multiVal">
               <select multiple="multiple"
                       tal:attributes="name string:${fieldName}:list;
                                       id string:$fieldId;
                                       size size | python: 8;
                                       tabindex tabindex/next;">

                <tal:repeat repeat="username value">
                  <tal:notnone tal:condition="python: username">
                  <option selected="selected"
                          tal:define="member python:mtool.getMemberInfo(username);
                                      fullname python:member and member['fullname'] or username;"
                          tal:attributes="value username"
                          tal:content="string:$username ($fullname)">
                  </option>
                  </tal:notnone>
                </tal:repeat>

               </select>
            </tal:multi>

            <div>
              <input type="button"
                   class="searchButton"
                   value="Browse..."
                   onClick=""
                   i18n:attributes="value button_browse"
                   tal:define="groupId groupId | string:'';
                               enableSearch enableSearch | python:1"
                   tal:attributes="onClick string:javascript:userandgroupselect_openBrowser('${here_url}', '${fieldId}', '${groupId}', ${multiVal})"
                   />
              <input type="button"
                   class="destructive"
                   value="Remove selected users"
                   onClick=""
                   i18n:attributes="value"
                   tal:attributes="onClick string:javascript:userandgroupselect_removeEntry('${fieldId}', ${multiVal});
                                   value python:multiVal and 'Remove selected users' or 'Remove user'"
                   />
            </div>

          </div> 

       </metal:use>
     </metal:edit_macro>

   </body>
</html>
